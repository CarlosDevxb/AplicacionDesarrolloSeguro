<div class="management-container">
  <header class="management-header">
    <h2>Gestión de Usuarios</h2>
    <p>Crea, busca, edita y visualiza los usuarios del sistema.</p>
  </header>

  <!-- Bloque para Listar Todos los Usuarios -->
  <div class="collapsible-block">
    <div class="collapsible-header" (click)="toggleListBlock()">
      <h4><i class="fas fa-users"></i> Ver Todos los Usuarios</h4>
      <i class="fas fa-chevron-down" [class.rotated]="showListBlock"></i>
    </div>
    <div class="collapsible-content" *ngIf="showListBlock">
      <div *ngIf="listIsLoading" class="text-center mt-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p>Cargando usuarios...</p>
      </div>

      <div *ngIf="listErrorMessage" class="alert alert-danger mt-3">
        {{ listErrorMessage }}
      </div>

      <div *ngIf="!listIsLoading && !listErrorMessage" class="table-responsive mt-4">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Nombre Completo</th>
              <th>ID / No. Control</th>
              <th>Correo Electrónico</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Último Acceso</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of allUsers">
              <td>{{ user.nombre_completo }}</td>
              <td>{{ user.id }}</td>
              <td>{{ user.correo }}</td>
              <td><span class="badge" [ngClass]="'role-' + user.rol">{{ user.rol }}</span></td>
              <td>
                <span class="badge" [ngClass]="{
                  'status-active': user.estado === 'activo',
                  'status-inactive': user.estado === 'no activo',
                  'status-blocked': user.estado === 'bloqueado'
                }">{{ user.estado }}</span>
              </td>
              <td class="last-access">
                {{ user.ultimo_acceso ? (user.ultimo_acceso | date:'short') : 'Nunca' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bloque para Crear Usuarios -->
  <div class="collapsible-block">
    <div class="collapsible-header" (click)="toggleCreateBlock('alumno')">
      <h4><i class="fas fa-user-graduate"></i> Registrar Nuevo Alumno</h4>
      <i class="fas fa-chevron-down" [class.rotated]="showCreateBlock === 'alumno'"></i>
    </div>
    <div class="collapsible-content" *ngIf="showCreateBlock === 'alumno'">
      <form [formGroup]="alumnoForm" (ngSubmit)="createUser('alumno')" class="user-form">
        <div class="form-grid">
          <div class="form-group"><label for="alumno-id">No. de Control</label><input id="alumno-id" type="text" formControlName="id"></div>
          <div class="form-group"><label for="alumno-nombre">Nombre Completo</label><input id="alumno-nombre" type="text" formControlName="nombre_completo"></div>
          <div class="form-group"><label for="alumno-correo">Correo</label><input id="alumno-correo" type="email" formControlName="correo"></div>
          <div class="form-group"><label for="alumno-carrera">Carrera</label><select id="alumno-carrera" formControlName="carrera_id"><option value="" disabled>Selecciona una carrera</option><option *ngFor="let c of carreras" [value]="c.id">{{c.nombre}}</option></select></div>
          <div class="form-group"><label for="alumno-ingreso">Fecha de Ingreso</label><input id="alumno-ingreso" type="date" formControlName="fecha_ingreso"></div>
        </div>
        <button type="submit" [disabled]="alumnoForm.invalid">Crear Alumno</button>
      </form>
    </div>
  </div>

  <div class="collapsible-block">
    <div class="collapsible-header" (click)="toggleCreateBlock('docente')">
      <h4><i class="fas fa-user-tie"></i> Registrar Nuevo Docente</h4>
      <i class="fas fa-chevron-down" [class.rotated]="showCreateBlock === 'docente'"></i>
    </div>
    <div class="collapsible-content" *ngIf="showCreateBlock === 'docente'">
      <form [formGroup]="docenteForm" (ngSubmit)="createUser('docente')" class="user-form">
        <div class="form-grid">
          <div class="form-group"><label for="docente-id">ID de Empleado</label><input id="docente-id" type="text" formControlName="id"></div>
          <div class="form-group"><label for="docente-nombre">Nombre Completo</label><input id="docente-nombre" type="text" formControlName="nombre_completo"></div>
          <div class="form-group"><label for="docente-correo">Correo</label><input id="docente-correo" type="email" formControlName="correo"></div>
        </div>
        <button type="submit" [disabled]="docenteForm.invalid">Crear Docente</button>
      </form>
    </div>
  </div>

  <div class="collapsible-block">
    <div class="collapsible-header" (click)="toggleCreateBlock('administrativo')">
      <h4><i class="fas fa-user-shield"></i> Registrar Nuevo Administrativo</h4>
      <i class="fas fa-chevron-down" [class.rotated]="showCreateBlock === 'administrativo'"></i>
    </div>
    <div class="collapsible-content" *ngIf="showCreateBlock === 'administrativo'">
      <form [formGroup]="adminForm" (ngSubmit)="createUser('administrativo')" class="user-form">
        <div class="form-grid">
          <div class="form-group"><label for="admin-id">ID de Empleado</label><input id="admin-id" type="text" formControlName="id"></div>
          <div class="form-group"><label for="admin-nombre">Nombre Completo</label><input id="admin-nombre" type="text" formControlName="nombre_completo"></div>
          <div class="form-group"><label for="admin-correo">Correo</label><input id="admin-correo" type="email" formControlName="correo"></div>
        </div>
        <button type="submit" [disabled]="adminForm.invalid">Crear Administrativo</button>
      </form>
    </div>
  </div>

  <!-- Mensaje de éxito/error para la creación -->
  <div *ngIf="createMessage" class="message-box info">{{ createMessage }}</div>

  <!-- Bloque para Buscar y Editar -->
  <div class="collapsible-block">
    <div class="collapsible-header" (click)="toggleSearchBlock()">
      <h4><i class="fas fa-search"></i> Buscar y Editar Usuario</h4>
      <i class="fas fa-chevron-down" [class.rotated]="showSearchBlock"></i>
    </div>
    <div class="collapsible-content" *ngIf="showSearchBlock">
      <div class="search-section">
        <input [formControl]="searchControl" type="text" placeholder="Ingresa No. de Control o ID de Empleado">
        <button (click)="searchUser()">Buscar</button>
      </div>

      <div *ngIf="searchMessage" class="message-box info">{{ searchMessage }}</div>

      <div *ngIf="searchedUser" class="edit-form-container">
        <hr>
        <h5>Editando a: {{ searchedUser.nombre_completo }}</h5>
        <form [formGroup]="editForm" (ngSubmit)="updateUser()" class="user-form">
          <div class="form-grid">
            <div class="form-group"><label>ID / No. de Control</label><input type="text" [value]="searchedUser.id" readonly></div>
            <div class="form-group"><label for="edit-rol">Rol</label><select id="edit-rol" formControlName="rol"><option value="alumno">Alumno</option><option value="docente">Docente</option><option value="administrativo">Administrativo</option></select></div>            
            <div class="form-group"><label for="edit-estado">Estado</label>
              <select id="edit-estado" formControlName="estado">
                <option value="activo">Activo</option><option value="no activo">No Activo</option><option value="bloqueado">Bloqueado</option>
              </select>
            </div>
            <div class="form-group"><label for="edit-nombre">Nombre Completo</label><input id="edit-nombre" type="text" formControlName="nombre_completo"></div>
            <div class="form-group"><label for="edit-correo">Correo</label><input id="edit-correo" type="email" formControlName="correo"></div>
            <div class="form-group"><label for="edit-telefono">Teléfono</label><input id="edit-telefono" type="tel" formControlName="telefono"></div>
            <div class="form-group"><label for="edit-direccion">Dirección</label><input id="edit-direccion" type="text" formControlName="direccion"></div>
            <div class="form-group" *ngIf="searchedUser.rol === 'alumno'"><label for="edit-estatus">Estatus Académico</label><select id="edit-estatus" formControlName="estatus"><option value="activo">Activo</option><option value="activo con especiales">Activo con Especiales</option><option value="baja temporal">Baja Temporal</option><option value="baja definitiva">Baja Definitiva</option><option value="egresado">Egresado</option></select></div>
          </div>
          <button type="submit" [disabled]="editForm.invalid">Actualizar Usuario</button>
        </form>
        <div *ngIf="updateMessage" class="message-box info">{{ updateMessage }}</div>
      </div>
    </div>
  </div>
</div>
